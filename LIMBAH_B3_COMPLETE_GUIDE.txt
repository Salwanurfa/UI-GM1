â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘       LIMBAH B3 FEATURE - COMPLETE CLEAN CODE & DOCUMENTATION         â•‘
â•‘                                                                        â•‘
â•‘  Semua perbaikan untuk error "Unexpected token <" sudah diterapkan    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

================================================================================
FILE 1: LimbahB3Service.php
================================================================================

LOKASI: app/Services/LimbahB3Service.php

KEY FIXES:
âœ… saveUser() - Action handling:
   - Jika action='kirim_ke_tps' â†’ status='dikirim_ke_tps'
   - Default atau action='simpan_draf' â†’ status='draft'

âœ… updateUser() - Same action handling for edit

âœ… Added verbose logging untuk tracking:
   - Input data logging
   - Payload prepared logging
   - Insert/update result logging
   - Exception backtrace logging

âœ… Added error_field indicator untuk client-side debugging

âœ… Added exception message di response untuk clarity

CRITICAL METHODS:
1. getUserIndexData()
   â†’ Returns: master_list dari master_limbah_b3 untuk dropdown

2. saveUser(array $data)
   â†’ Validates: master_b3_id, timbulan, satuan (required)
   â†’ Sets status berdasarkan action parameter
   â†’ Inserts ke limbah_b3 dengan correct field mapping
   â†’ Returns JSON response

3. updateUser(int $id, array $data)
   â†’ Same validation & action handling sebagai saveUser
   â†’ Only edit jika status='draft' atau 'ditolak_tps'

4. deleteUser(int $id)
   â†’ Only delete jika status='draft'

5. getActiveMasterList()
   â†’ Gets all master_limbah_b3 records untuk dropdown

ACTION LOGIC:
```php
// Baris ~130-135 di saveUser()
$status = 'draft'; // Default status
if (isset($data['action']) && $data['action'] === 'kirim_ke_tps') {
    $status = 'dikirim_ke_tps';
}
```

================================================================================
FILE 2: LimbahB3.php (Controller)
================================================================================

LOKASI: app/Controllers/User/LimbahB3.php

KEY FIXES:
âœ… Line 54 - Fixed default action in save():
   'action' => $post['action'] ?? 'simpan_draf',  â† Changed from 'draf'

âœ… Line 93 - Fixed default action in edit():
   'action' => $post['action'] ?? 'simpan_draf',  â† Changed from 'draf'

âœ… All endpoints return setJSON() - NO echo/print_r

ENDPOINTS:
1. POST /user/limbah-b3/save
   â†’ Menerima: master_b3_id, lokasi, timbulan, satuan, bentuk_fisik, kemasan, action
   â†’ Calls: Service.saveUser()
   â†’ Returns: JSON { success, message, data }

2. GET /user/limbah-b3/get/{id}
   â†’ Returns: { success, data } dengan master info

3. POST /user/limbah-b3/edit/{id}
   â†’ Same param sebagai save
   â†’ Calls: Service.updateUser()
   â†’ Returns: JSON response

4. POST /user/limbah-b3/delete/{id}
   â†’ Calls: Service.deleteUser()
   â†’ Returns: JSON response

5. GET /user/limbah-b3/master/{id}
   â†’ AJAX endpoint untuk master detail

ALL RETURN FORMAT:
```php
return $this->response
    ->setContentType('application/json')
    ->setJSON($result);  â† NO echo before this
```

================================================================================
FILE 3: limbah_b3.php (View)
================================================================================

LOKASI: app/Views/user/limbah_b3.php

KEY FIXES:
âœ… Enhanced JavaScript error handling dengan verbose logging

âœ… Added response content-type validation

âœ… Added raw HTML response display jika error

âœ… Emoji logging untuk clarity

CRITICAL FORM ELEMENTS:

1. Master Dropdown (Line ~480):
```html
<select id="master_b3_id" name="master_b3_id">
    <option value="">-- Pilih --</option>
    <?php foreach ($master_list as $m): ?>
        <option value="<?= $m['id'] ?>"
                data-kode="<?= esc($m['kode_limbah']) ?>"
                data-kategori="<?= esc($m['kategori_bahaya']) ?>">
            <?= esc($m['nama_limbah']) ?>
        </option>
    <?php endforeach; ?>
</select>
```
â†’ PENTING: data-kode & data-kategori attributes untuk auto-fill

2. Auto-Fill Fields:
```html
<input type="text" id="kode_limbah_display" readonly>
<input type="text" id="kategori_bahaya_display" readonly>
```
â†’ Auto-filled saat master dipilih

3. Action Buttons (Line ~600):
```html
<button type="submit" value="simpan_draf" ...>
    Simpan sebagai Draft
</button>

<button type="submit" value="kirim_ke_tps" ...>
    Kirim ke TPS
</button>
```
â†’ PENTING: value= harus sesuai ('simpan_draf' atau 'kirim_ke_tps')

JAVASCRIPT AUTO-FILL (Line ~650):
```javascript
$('#master_b3_id').on('change', function() {
    const selectedOption = $(this).find('option:selected');
    const kode = selectedOption.data('kode') || '';
    const kategori = selectedOption.data('kategori') || '';
    
    $('#kode_limbah_display').val(kode);
    $('#kategori_bahaya_display').val(kategori);
});
```

FORM SUBMISSION (Line ~700+):
```javascript
const limbahId = document.getElementById('limbah_id').value;
const action = e.submitter.value; // Gets button value: 'simpan_draf' atau 'kirim_ke_tps'

const formData = new FormData(this);
formData.append('action', action);  // â† IMPORTANT: Append action

const url = limbahId 
    ? '<?= base_url('user/limbah-b3/edit/') ?>' + limbahId
    : '<?= base_url('user/limbah-b3/save') ?>';

const response = await fetch(url, { method: 'POST', body: formData });
```

ERROR HANDLING (Line ~750+):
```javascript
// Check content-type
const contentType = response.headers.get('content-type');
if (!contentType || !contentType.includes('application/json')) {
    const rawText = await response.text();
    console.error('âŒ ERROR: Server returned non-JSON response!');
    console.error('ğŸ” Raw Response:', rawText);
    toast.error('Server error: ' + rawText.substring(0, 200));
    return;
}

// Parse & handle response
const data = await response.json();
if (data.success) {
    setTimeout(() => location.reload(), 1000);
} else {
    toast.error(data.message);
}
```

================================================================================
DATA FLOW DIAGRAM
================================================================================

USER CLICKS "KIRIM KE TPS"
        â†“
JavaScript captures:
  - form data (master_b3_id, lokasi, timbulan, satuan)
  - action = 'kirim_ke_tps' (from button value)
  - sends to /user/limbah-b3/save
        â†“
Controller.save() receives:
  - $post['master_b3_id'] = 1
  - $post['action']       = 'kirim_ke_tps'
  - Default action from (??) = 'simpan_draf' (not used if action sent)
  - Calls Service.saveUser([ ... 'action' => 'kirim_ke_tps'])
        â†“
Service.saveUser() processes:
  - Log: Input data
  - Validate: master_b3_id, timbulan, satuan
  - Check: action === 'kirim_ke_tps' ?
    â†’ YES: $status = 'dikirim_ke_tps'
    â†’ NO/DEFAULT: $status = 'draft'
  - Prepare payload:
    [ 'id_user' => 1,
      'master_b3_id' => 1,
      'status' => 'dikirim_ke_tps', â† KEY
      ... other fields ]
  - Log: Prepared payload
  - Model.insert(payload)
  - Log: Insert success/fail
  - Return: { success: true/false, message: '...', data: {...} }
        â†“
Controller returns:
  - setJSON($result) â†’ JSON response
        â†“
JavaScript receives:
  - Parse JSON
  - Check content-type âœ…
  - if success â†’ show message & reload page
  - if fail â†’ show error message
        â†“
Page reloads & shows new record in table with status='dikirim_ke_tps'

================================================================================
DEBUG CHECKLIST
================================================================================

Browser Console (F12):
â–¡ See "ğŸ“¤ Submitting to: /user/limbah-b3/save"
â–¡ See "ğŸ“‹ Action: kirim_ke_tps"
â–¡ See all form data logged
â–¡ See "ğŸ“Š Response Status: 200"
â–¡ See "ğŸ“Š Response Headers: application/json"
â–¡ See "âœ… Parsed JSON Response"
â–¡ See "ğŸ‰ Success! Reloading..."

If Error:
â–¡ See "âŒ ERROR: Server returned non-JSON"
â–¡ See "ğŸ” Raw Response" with HTML error
â–¡ Copy error HTML to check what went wrong

PHP Logs (writable/logs/log-2026-02-26.log):
â–¡ "LimbahB3Service::saveUser called with data: {...}"
â–¡ "Prepared payload: {...}" - check if status='dikirim_ke_tps'
â–¡ "Insert success with message: ..."
â–¡ OR "Exception: ..." if error

Database:
â–¡ SELECT * FROM limbah_b3 ORDER BY id DESC LIMIT 1;
â–¡ Check: status column = 'dikirim_ke_tps'
â–¡ Check: master_b3_id = selected value
â–¡ Check: id_user = your user id

================================================================================
FIELD MAPPING REFERENCE
================================================================================

HTML Form Input â†’ Post Data â†’ Service Param â†’ Database Column
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

#master_b3_id dropdown
  â””â”€> $_POST['master_b3_id']
      â””â”€> $data['master_b3_id']
          â””â”€> limbah_b3.master_b3_id (FK to master_limbah_b3)

#lokasi dropdown
  â””â”€> $_POST['lokasi']
      â””â”€> $data['lokasi']
          â””â”€> limbah_b3.lokasi

#timbulan input
  â””â”€> $_POST['timbulan']
      â””â”€> (float) $data['timbulan']
          â””â”€> limbah_b3.timbulan

#satuan dropdown
  â””â”€> $_POST['satuan']
      â””â”€> $data['satuan']
          â””â”€> limbah_b3.satuan

[Action Button Value] â†’ formData.append('action', value)
  â””â”€> $_POST['action'] = 'kirim_ke_tps' OR 'simpan_draf'
      â””â”€> $data['action']
          â””â”€> Decision: status = 'draft' OR 'dikirim_ke_tps'
              â””â”€> limbah_b3.status

Session User
  â””â”€> session()->get('user')['id']
      â””â”€> $user['id']
          â””â”€> limbah_b3.id_user

================================================================================
REQUIRED DATABASE STATE
================================================================================

âœ… Table: limbah_b3
   - Columns: id, id_user, master_b3_id, lokasi, timbulan, satuan,
             bentuk_fisik, kemasan, status, tanggal_input
   - Status ENUM: 'draft', 'dikirim_ke_tps', 'disetujui_tps', 'ditolak_tps', 'disetujui_admin'
   - FK: master_b3_id â†’ master_limbah_b3

âœ… Table: master_limbah_b3
   - Contains: At least 9 records (Oli Bekas, Grease, etc.)
   - Columns: id, nama_limbah, kode_limbah, kategori_bahaya, karakteristik

================================================================================
EVERYTHING IS READY FOR TESTING
================================================================================

All syntax validated âœ…
All action handlers fixed âœ…
All error handlers enhanced âœ…
All logging implemented âœ…

Next: Open browser â†’ F12 console â†’ Test in http://localhost:8080/user/limbah-b3
